<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Candy Auto Sender</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        font-family: Arial;
        background: #111;
        color: #0f0;
        padding: 20px;
      }
      .log-box {
        background: #000;
        padding: 15px;
        border-radius: 8px;
        height: 400px;
        overflow-y: auto;
        border: 1px solid #333;
      }
    </style>
  </head>

  <body>
    <h2>ğŸ¬ Candy Auto WhatsApp Sender</h2>
    <p>Listening for new rows in <b>web_bookings</b>. Keep this page open.</p>

    <div class="log-box" id="log"></div>

    <script>
      // -------------------------------------------------------
      // SUPABASE CONFIG (same as offers.html)
      // -------------------------------------------------------
      const SUPABASE_URL = "https://ylsbmxedhycjqaorjkvm.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsc2JteGVkaHljanFhb3Jqa3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTk5NTUsImV4cCI6MjA3NjM5NTk1NX0.W61xOww2neu6RA4yCJUob66p4OfYcgLSVw3m3yttz1E";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // -------------------------------------------------------
      // LOGGER (same look as your debug box style)
      // -------------------------------------------------------
      function log(msg) {
        const box = document.getElementById("log");
        const time = new Date().toLocaleTimeString("ar-EG");
        box.innerHTML += `<div>[${time}] â¤ ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
      }

      // -------------------------------------------------------
      // SAME WHATSAPP SENDER FROM YOUR offers.html
      // FIXED PHONE NUMBER = 962785050875
      // -------------------------------------------------------
      async function sendWhatsAppMessage(messageText) {
        try {
          const payload = {
            name: "Smile Clinic",
            phone: "962785050875", // *** FIXED NUMBER HERE ***
            service: "New Booking",
            appointment: messageText,
            image: null,
          };

          log("ğŸ“¤ Sending WhatsApp message...");

          const res = await fetch(
            "https://whatsapp-test-rosy.vercel.app/sendWhatsApp",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          const data = await res.json();

          if (data.success) {
            log("âœ… WhatsApp sent successfully!");
          } else {
            log("âŒ WhatsApp failed: " + JSON.stringify(data));
          }
        } catch (err) {
          log("âŒ ERROR sending message: " + err.message);
        }
      }

      // -------------------------------------------------------
      // REALTIME LISTENER (INSERT)
      // -------------------------------------------------------
      supabase
        .channel("booking-auto-sender")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "web_bookings" },
          (payload) => {
            log("ğŸ‰ NEW BOOKING ADDED!");

            const newRow = payload.new;

            const name = newRow.name;
            const phone = newRow.phone;
            const service = newRow.service;

            log(`ğŸ‘¤ Name: ${name}`);
            log(`ğŸ“ Phone: ${phone}`);
            log(`ğŸ¦· Service: ${service}`);

            // Build message text
            const messageText = `Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯!\nØ§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ø®Ø¯Ù…Ø©: ${service}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${phone}`;

            // Send WhatsApp to your fixed number
            sendWhatsAppMessage(messageText);
          }
        )
        .subscribe();

      log("ğŸ‘‚ Candy Auto Sender is running... waiting for new rows.");
    </script>
  </body>
</html>
