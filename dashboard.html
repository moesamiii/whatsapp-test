<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Clinic Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(to bottom, #f3f9ff, #e8f1fa);
        color: #333;
        transition: 0.3s;
      }
      body.dark {
        background: #111;
        color: #ddd;
      }
      header {
        background: #2a6cb3;
        color: #fff;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px #0002;
      }
      header h1 {
        font-size: 22px;
      }
      .container {
        max-width: 1100px;
        margin: 25px auto;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 3px 10px #0001;
        transition: 0.3s;
      }
      body.dark .container {
        background: #1b1b1b;
      }
      .stats {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 25px;
      }
      .stat {
        flex: 1;
        min-width: 200px;
        background: #f6faff;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px #0001;
        transition: 0.3s;
      }
      .stat:hover {
        transform: scale(1.03);
      }
      body.dark .stat {
        background: #222;
        color: #ddd;
      }
      .filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      input,
      select {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        background: #2a6cb3;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s;
      }
      button:hover {
        opacity: 0.8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
        margin-top: 10px;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        background: #2a6cb3;
        color: #fff;
        cursor: pointer;
      }
      tr:hover {
        background: #f7faff;
      }
      body.dark table,
      body.dark tr:hover {
        background: #222;
        color: #ddd;
      }
      footer {
        text-align: center;
        padding: 12px;
        color: #666;
        font-size: 13px;
      }
      canvas {
        margin-top: 20px;
      }
      @media (max-width: 700px) {
        .stats {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>üìä Clinic Dashboard</h1>
        <p style="font-size: 13px; opacity: 0.9">Google Sheets live sync</p>
      </div>
      <div>
        <button id="themeBtn">üåô</button>
      </div>
    </header>

    <div class="container">
      <div class="stats">
        <div class="stat">
          <h2 id="total">0</h2>
          <p>Total Bookings</p>
        </div>
        <div class="stat">
          <h2 id="today">0</h2>
          <p>Today's Bookings</p>
        </div>
        <div class="stat">
          <h2 id="popular">-</h2>
          <p>Most Popular Service</p>
        </div>
      </div>

      <div class="filter-bar">
        <div>
          <input
            id="search"
            placeholder="üîç Search name, phone, or service..."
          />
          <input type="date" id="dateFilter" />
          <button onclick="downloadCSV()">‚¨á Export</button>
        </div>
        <button onclick="load()">üîÑ Refresh</button>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Service</th>
            <th>Appointment</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div
        style="
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          justify-content: center;
        "
      >
        <canvas id="bar" width="400" height="200"></canvas>
        <canvas id="pie" width="200" height="200"></canvas>
      </div>
    </div>

    <footer>¬© 2025 Smile Clinic ‚Äî Auto refreshes every 15s</footer>

    <script>
      let bar, pie;
      const q = (s) => document.querySelector(s);
      const animateNum = (el, to) => {
        let n = 0;
        const s = to / 40;
        const i = setInterval(() => {
          n += s;
          el.textContent = Math.min(Math.round(n), to);
          if (n >= to) clearInterval(i);
        }, 15);
      };

      async function load() {
        const res = await fetch("/api/bookings");
        let data = await res.json();
        const s = q("#search").value.toLowerCase(),
          d = q("#dateFilter").value;
        data = data.filter(
          (b) =>
            (b.name?.toLowerCase().includes(s) ||
              b.phone?.includes(s) ||
              b.service?.toLowerCase().includes(s)) &&
            (!d || b.timestamp?.startsWith(d))
        );
        renderTable(data);
        updateStats(data);
        drawCharts(data);
      }

      function renderTable(d) {
        const tb = q("#tbl tbody");
        tb.innerHTML = "";
        d.forEach((b) => {
          const r = document.createElement("tr");
          r.innerHTML = `<td>${b.name || "-"}</td><td>${
            b.phone || "-"
          }</td><td>${b.service || "-"}</td><td>${
            b.appointment || "-"
          }</td><td>${
            b.timestamp ? new Date(b.timestamp).toLocaleString() : "-"
          }</td>`;
          tb.appendChild(r);
        });
      }

      function updateStats(d) {
        animateNum(q("#total"), d.length);
        const today = new Date().toISOString().split("T")[0];
        animateNum(
          q("#today"),
          d.filter((b) => b.timestamp?.startsWith(today)).length
        );
        const sc = {};
        d.forEach(
          (b) => b.service && (sc[b.service] = (sc[b.service] || 0) + 1)
        );
        const top = Object.entries(sc).sort((a, b) => b[1] - a[1])[0];
        q("#popular").textContent = top ? top[0] : "N/A";
      }

      function drawCharts(d) {
        const sc = {};
        d.forEach((b) => (sc[b.service] = (sc[b.service] || 0) + 1));
        const labels = Object.keys(sc),
          vals = Object.values(sc);
        if (bar) bar.destroy();
        if (pie) pie.destroy();
        bar = new Chart(q("#bar"), {
          type: "bar",
          data: {
            labels,
            datasets: [{ data: vals, backgroundColor: "#2a6cb3" }],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });
        pie = new Chart(q("#pie"), {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: vals,
                backgroundColor: [
                  "#2a6cb3",
                  "#5fb1e0",
                  "#8fd2a7",
                  "#f6c343",
                  "#f47b7b",
                ],
              },
            ],
          },
          options: { plugins: { legend: { position: "bottom" } } },
        });
      }

      function downloadCSV() {
        fetch("/api/bookings")
          .then((r) => r.json())
          .then((d) => {
            const csv = [
              "Name,Phone,Service,Appointment,Time",
              ...d.map(
                (b) =>
                  `${b.name},${b.phone},${b.service},${b.appointment},${b.timestamp}`
              ),
            ].join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "bookings.csv";
            a.click();
          });
      }

      // theme toggle
      const btn = q("#themeBtn");
      btn.onclick = () => {
        document.body.classList.toggle("dark");
        btn.textContent = document.body.classList.contains("dark")
          ? "‚òÄÔ∏è"
          : "üåô";
        localStorage.setItem("dark", document.body.classList.contains("dark"));
      };
      if (localStorage.getItem("dark") === "true") {
        document.body.classList.add("dark");
        btn.textContent = "‚òÄÔ∏è";
      }
      q("#search").oninput = q("#dateFilter").onchange = load;
      load();
      setInterval(load, 15000);
    </script>
  </body>
</html>
